apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: drbd-adapter
  labels:
    k8s-app: drbd-adapter
spec:
  selector:
    matchLabels:
      k8s-app: drbd-adapter
  template:
    metadata:
      labels:
        k8s-app: drbd-adapter
    spec:
      initContainers:
      - name: shipper
        image: {{ $.Values.registry }}/drbd9-shipper:{{ $.Values.drbdVersion }}
        imagePullPolicy: {{ $.Values.imagePullPolicy }}
        volumeMounts:
        - name: pkgs
          mountPath: /pkgs
      {{- $distros := $.Values.distros }}
      {{- if $distros -}}
      {{ else }}
        {{- $distros = append $distros "flatcar" }}
        {{- range $index, $node := (lookup "v1" "Node" "" "").items }}
          {{- $osImage := lower $node.status.nodeInfo.osImage }}
          {{- with . -}}
            {{- if regexMatch "(red hat enterprise|centos) .*7" $osImage }}
              {{- $distros = append $distros "rhel7" }}
            {{- else if regexMatch "(red hat enterprise|centos) .*8" $osImage }}
              {{- $distros = append $distros "rhel8" }}
            {{- else if regexMatch "ubuntu .*18" $osImage }}
              {{- $distros = append $distros "bionic" }}
            {{- else if regexMatch "ubuntu .*20" $osImage }}
              {{- $distros = append $distros "focal" }}
            {{- else if regexMatch "ubuntu .*22" $osImage }}
              {{- $distros = append $distros "jammy" }}
            {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}
      {{- range $index, $dist := $distros | uniq }}
      {{- if regexMatch "^(rhel[78]|bionic|focal|jammy)$" $dist }}
      {{- $tag := $.Values.drbdVersion  }}
      {{- if eq $dist "jammy" }}
        {{- $tag = "v9.1.10" }}
      {{- end }}
      - name: {{ $dist }}
        image: {{ $.Values.registry }}/drbd9-{{ $dist }}:{{ $tag }}
        imagePullPolicy: {{ $.Values.imagePullPolicy }}
        command: [ /pkgs/entrypoint.adapter.sh ]
        securityContext:
          privileged: true
        env:
        - name: LB_DROP
          value: {{ $.Values.drop | quote }}
        - name: LB_UPGRADE
          value: {{ $.Values.upgrade | quote }}
        volumeMounts:
        {{- if regexMatch "^rhel[78]$" $dist }}
        - name: centos-release
          mountPath: /etc/centos-release
          readOnly: true
        {{- end }}
        - name: pkgs
          mountPath: /pkgs
        - name: os-release
          mountPath: /etc/host-release
          readOnly: true
        - name: usr-src
          mountPath: /usr/src
          readOnly: true
        - name: lib-modules
          mountPath: /lib/modules
        - name: usr-local
          mountPath: /usr-local
        - name: etc-drbd-conf
          mountPath: /etc/drbd.conf
        - name: etc-drbd-d
          mountPath: /etc/drbd.d
        - name: var-lib-drbd
          mountPath: /var/lib/drbd
          readOnly: true
        - name: etc-modules-load
          mountPath: /etc/modules-load.d
        {{- end }}
        {{- end }}
      containers:
      - name: monitor
        # Source registry: quay.io/piraeusdatastore/drbd-reactor
        image: {{ $.Values.registry}}/drbd-reactor:{{ $.Values.drbdReactorVersion}}
        imagePullPolicy: {{ .Values.imagePullPolicy}}
        {{- if regexMatch "^9.1." $.Values.drbdVersion }} # DRBD Reactor only supports DRBD 9.1.x
        command:
        - /usr/sbin/drbd-reactor
        - -c
        - /pkgs/drbd-reactor.toml
        {{- else }}
        command:
        - tail 
        - -f
        - /dev/null     
        {{- end }}  
        volumeMounts:
        - name: pkgs
          mountPath: /pkgs
          readOnly: true
      hostNetwork: true
      terminationGracePeriodSeconds: 0
      volumes:
      - name: pkgs
        emptyDir: {}
      - name: os-release
        hostPath:
          path: /etc/os-release
      - name: centos-release
        hostPath:
          path: /etc/centos-release
      - name: usr-src
        hostPath:
          path: /usr/src    
      - name: lib-modules
        hostPath:
          path: /lib/modules
      - name: usr-local
        hostPath:
          path: /usr/local
      - name: etc-drbd-conf
        hostPath:
          path: /etc/drbd.conf
          type: FileOrCreate
      - name: etc-drbd-d
        hostPath:
          path: /etc/drbd.d
          type: DirectoryOrCreate
      - name: var-lib-drbd
        hostPath:
          path: /var/lib/drbd
          type: DirectoryOrCreate
      - name: etc-modules-load
        hostPath:
          path: /etc/modules-load.d
      affinity:
        nodeAffinity:
		    {{- toYaml $.Values.affinity.nodeAffinity | nindent 10 }}
